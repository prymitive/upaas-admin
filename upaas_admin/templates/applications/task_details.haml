- extends 'site.html'


- load i18n
- load django_bootstrap_breadcrumbs
- load gravatar


- block breadcrumbs
  = block.super
  - breadcrumb task.application.name "app_details" task.application.safe_id
  - breadcrumb "Tasks" "app_tasks" task.application.safe_id
  - breadcrumb task.title "task_details" task.safe_id


- block content

  .progress.upaas-task-details-progressbar
    #task-progress.progress-bar{'role':'progressbar', 'aria-valuenow':'{{ task.progress }}', 'aria-valuemin':'0', 'aria-valuemax':'100', 'style':'width: {{ task.progress }}%;'}
      %span.sr-only

  .upaas-messages-table-area
    %table#upaas-task-messages-table.table.table-striped.table-condensed
      %thead
        %tr
          %th
            - trans "Created"
          %th
            - trans "Message"
      %tbody.small


  :javascript
    var offset = 0;
    var progress = {{ task.progress }};

    function messages_callback(data) {
      if (progress != data.progress) {
        $('#task-progress').attr('aria-valuenow', data.progress).attr('style', 'width: ' + data.progress + '%;');;
        progress = data.progress;
      }

      var elems = new Array();
      $.each(data.messages, function(i, item) {
        offset++;
        elem = new Array();
        var textClass = '';
        switch(item.level) {
          case "WARNING":
            textClass = "warning";
            break;
          case "ERROR":
            textClass = 'danger';
            break;
        }
        elem.push('<tr class="' + textClass + '">');
        elem.push('<td class="upaas-task-messages-col-created">'
                  + moment(item.timestamp).fromNow() + '</td>');
        elem.push('<td>' + item.message + '</td>');
        elem.push('</tr>');
        elems.push(elem.join(''));
      });
      if (elems.length > 0) {
        $('#upaas-task-messages-table tbody').append(elems.join('\n'));
        $(".upaas-messages-table-area").animate({
          scrollTop: $('#upaas-task-messages-table tr:last').position().top
          }, 300);
      }
    }

    function update_messages() {
      Dajaxice.upaas_admin.apps.applications.task_messages(messages_callback, {
        "task_id":"{{ task.safe_id }}",
        "offset": offset
      });
    }

    $(document).ready(function(){
      window.setTimeout(update_messages, 1000);
      window.setInterval(update_messages, 3000);
    });
